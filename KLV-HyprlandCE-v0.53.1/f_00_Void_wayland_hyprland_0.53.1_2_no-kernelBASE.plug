# f_00_Void_wayland_hyprland_no-kernelBASE.plug
# Sofiya Creation date 06.01.2024; Revision date:10.02.2025
# Copyright FirstRib team 06.01.2024+; Licence MIT (aka X11 license)
# version="0.53.1_2"; revision="CE-7.0"
# Can boot result using suitable huge-kernel/00modules/01firmware and FR skeleton initrd

## NOTES:
# JUST READ THE FOLLOWING TO UNDERSTAND HOW TO CUSTOMISE THE BUILD!
# 

# Install packages
#
echo base-minimal ncurses-base file \
| xargs -n1 xbps-install -Syu
echo eudev seatd dbus-elogind elogind polkit sudo mesa-dri libgpg-error \
| xargs -n1 xbps-install -y
echo xdg-utils binutils snappy curl wget unzip xz zstd zip 7zip p7zip fuse zsync rsync \
| xargs -n1 xbps-install -y
echo gvfs gvfs-mtp gvfs-smb gvfs-cdda ntfs-3g \
| xargs -n1 xbps-install -y
echo bash vpm light chrony \
| xargs -n1 xbps-install -y
echo NetworkManager kmod libkmod void-artwork \
| xargs -n1 xbps-install -y
echo python3-requests python3-ijson python3 python3-PyVirtualDisplay python3-gobject \
| xargs -n1 xbps-install -Sy
echo SwayNotificationCenter wofi rofi wmenu lavalauncher Waybar swaybg \
| xargs -n1 xbps-install -y
echo wayland-utils wev wtype wl-clipboard wayclip wf-recorder wob light \
| xargs -n1 xbps-install -y
echo sway-audio-idle-inhibit wlr-randr wlsunset wlogout playerctl conky pywal swww \
| xargs -n1 xbps-install -y
echo font-bh-ttf cantarell-fonts font-liberation-ttf font-awesome6 font-fira-ttf font-inconsolata-otf dejavu-fonts-ttf noto-fonts-emoji nerd-fonts-symbols-ttf fonts-roboto-ttf \
| xargs -n1 xbps-install -Sy
echo qt5-wayland qt6-wayland bc j jq yad xorg-server-xwayland daemonize herbe xlsclients glfw-wayland \
| xargs -n1 xbps-install -y

# add hyprland github mirror repository-x86_64-glibc
cat <<'SETMIRROR' > /etc/xbps.d/99-repository-hyprland.conf
repository=https://raw.githubusercontent.com/sofijacom/hyprland-void/repository-x86_64-glibc
SETMIRROR

# add nwg github nwg-repository.conf
cat <<'SETMIRROR' > /etc/xbps.d/nwg-repository.conf
repository=https://github.com/Kennel-Linux/nwg/releases/latest/download
SETMIRROR

cat <<'EOF' >> /var/db/xbps/keys/b3:21:c4:43:d9:38:6f:ec:36:64:0d:65:37:13:c1:fe.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>public-key</key>
	<data>LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFqNWxheUVFWEVKVk00dXpLcGdaNwpmNUN6UHNLTlJUVXlJVzVuRWV3TDg0UUFOZTdIeEViUno1RFNtTkMxWFlwemRJZ1hXcnA0L21mcnY1aTJoV1VzCmVTSXFPNGY5bDE4a2xoMlZBRUdJVW40ckZIRnNHUHllc3Zhd21mdkFUUEZTYU4rbld5SExLTFUycVQyTzdtYnUKTEsyTU4yZGsra3RIV29kZCt2aFprbUxxb0Z5cTEyYWY0WXhud1BOYy8vbFpaR2ZqQkNMcStrQmNjOVFPaHQySQpxb0xsUmpvUVhCZXdhM1dNMHkwTGk1WGx2YUs3WVhEOXR1MEVJWmErYlRNVkZJVUl4dUxIVHVwWHpBOUNoQ2szClcxUDlINVJnNnNIZ1pNc0h3aHgvMEFkQlVXQmhtWG80SnFOcnZ0SG1RaFNkMURxdEU4eGNKdng3T2YwdnJGSjIKRHdJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==</data>
	<key>public-key-size</key>
	<integer>2048</integer>
	<key>signature-by</key>
	<string>hyprland-void-github-action</string>
</dict>
</plist>

EOF

cat <<'EOF' >> /var/db/xbps/keys/00:ca:42:57:c9:c0:9a:ec:94:b4:7d:97:e5:a9:aa:1e.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>public-key</key>
	<data>LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF6aFR1SkVjalBFZzZaUnNGbThtLwpaRnY0RWoyNUZVZzRZR3JQZlI3cWdaaGs5MExWd1hnTnVBQVl2TXFrSmpDd1dueEdYZVNzWUgyNFpSaFhiSHNvCm1DOGJFSDBOWkpmWGRYWFl3Rjg1dGl3b0RGRkpxOE0wN3daT0JsVmI4YXhkRm96UElpWXlRUEMxN1BwTjg0UksKS3NzZkJtQmt0dDUwbGptUWpmQW5lV21tZzF5VTRlSWZvR3AvamgrWW9TUGkyTzZTQi9ZVVJpZnNFYmlUK1RoMQpGdmpZTWhCb1VmQ2NGaGlIb3hDWXJOREhNOURSM21lUVI5ZkFuTEhKNEdXclhoMy84TjFhTngwcnZXckdSNDlJCkJrenNJdjErL2hHNzdyVG54Z3VPNGx0QVZ0QnljdVhRa2ZoWlpzMCtNSXphMzZpaVJja1lVRVVzYVFtQkJnUXMKaHdJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==</data>
	<key>public-key-size</key>
	<integer>2048</integer>
	<key>signature-by</key>
	<string>xlibre-github-actions</string>
</dict>
</plist>

EOF

xbps-install -Syu

echo hyprland hyprland-devel hyprland-protocols hyprland-qt-support hyprland-qtutils xdg-desktop-portal-hyprland tomlplusplus \
| xargs -n1 xbps-install -Sy
echo glaze hyprpaper hyprlock hyprpolkitagent hyprsunset hyprsysteminfo \
| xargs -n1 xbps-install -y
echo libspng sdbus-cpp aquamarine hypridle hyprutils hyprshot hyprland-guiutils \
| xargs -n1 xbps-install -y
echo nwg-drawer waypaper nwg-displays nwg-look \
| xargs -n1 xbps-install -y

# System Audio/Multimedia /wireplumber
echo pipewire wireplumber alsa-pipewire pavucontrol pamixer ffmpeg mpv qpwgraph cava cava-gui \
| xargs -n1 xbps-install -Sy
mkdir -p /etc/pipewire/pipewire.conf.d
ln -s /usr/share/examples/wireplumber/10-wireplumber.conf /etc/pipewire/pipewire.conf.d/
mkdir -p /etc/pipewire/pipewire.conf.d
ln -s /usr/share/examples/pipewire/20-pipewire-pulse.conf /etc/pipewire/pipewire.conf.d/

# for system-wide customization or for individual customization.
: "${XDG_CONFIG_HOME:=${HOME}/.config}"
mkdir -p "${XDG_CONFIG_HOME}/pipewire/pipewire.conf.d"
ln -s /usr/share/examples/wireplumber/10-wireplumber.conf "${XDG_CONFIG_HOME}/pipewire/pipewire.conf.d/"
ln -s /usr/share/examples/pipewire/20-pipewire-pulse.conf "${XDG_CONFIG_HOME}/pipewire/pipewire.conf.d/"

# ALSA Integration
mkdir -p /etc/alsa/conf.d
ln -s /usr/share/alsa/alsa.conf.d/50-pipewire.conf /etc/alsa/conf.d
ln -s /usr/share/alsa/alsa.conf.d/99-pipewire-default.conf /etc/alsa/conf.d

# Applications installed (alter these according to your wishes)xterm
echo wayvnc swappy wlclock grim zenity slurp grimshot maim micro pfetch hddtemp \
| xargs -n1 xbps-install -Sy
echo imv lxtask foot sakura geany leafpad pcmanfm gsimplecal-gtk3 ranger nnn git vim fish-shell \
| xargs -n1 xbps-install -y
echo galculator firefox smplayer brightnessctl mtpaint xdg-user-dirs hyprpicker ImageMagick eza kvantum \
| xargs -n1 xbps-install -y
echo xwininfo xmessage cpupower neofetch octoxbps squashfs-tools gettext xhost e2fsprogs dosfstools mtools syslinux \
| xargs -n1 xbps-install -y
echo wvkbd clipman cliphist dconf btop htop rsClock cmatrix gparted w3m w3m-img xarchiver kitty \
| xargs -n1 xbps-install -y

# Bluetooth
# bluez-alsa
echo bluez blueman libspa-bluetooth \
| xargs -n1 xbps-install -y
ln -s /etc/sv/bluetoothd /etc/runit/runsvdir/default/bluetoothd
usermod -G bluetooth -a spot

# Cups print service
echo cups cups-filters cups-pdf samba-cups \
| xargs -n1 xbps-install -y
ln -s /etc/sv/cupsd /etc/runit/runsvdir/default/cupsd

# Change default shell to fish
# chsh -s /bin/fish

#### Get KLV custom packages ####
#
# Create and switch to build directory
mkdir -p /root/Build
cd /root/Build

wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/tzupdate2-2.0_2.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/Create-xbps-tools-1.2_1.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/uextract-4.7_1.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/save2flash-1.9_0.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/pup-volume-monitor-1.15_0.x86_64.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/hyprland-0.53.1_2/Hyprland-rofi-home-bar-config-0.53.1_2.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/hyprland-0.53.1_2/Hyprland-icons-themes-4.0_1.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/epdfview-0.1.8_12.x86_64.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/usbimager-1.0.10_1.x86_64.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/pcompress-1.5_1.noarch.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/hardinfo2-2.2.0_1.x86_64.xbps
wget -c https://gitlab.com/sofija.p2018/kla-ot2/-/raw/main/KLA-Hyprland/xbps-program/Yradio-Hypr-1.8_1.noarch.xbps

# Register and index packages
cd /root
xbps-rindex -a Build/*.xbps

# Install tzupdate
xbps-install -y --repository=Build/ tzupdate2-2.0_2

# Install Create-xbps-tools
xbps-install -y --repository=Build/ Create-xbps-tools-1.2_1

# Install uextract
xbps-install -y --repository=Build/ uextract-4.7_1

# Install save2flash
xbps-install -y --repository=Build/ save2flash-1.9_0

# Install pup-volume-monitor
xbps-install -y --repository=Build/ pup-volume-monitor-1.15_0

# Install Hyprland-rofi-bar-config
xbps-install -y --repository=Build/ Hyprland-rofi-home-bar-config-0.53.1_2

# Install Hyprland-icons-themes
xbps-install -y --repository=Build/ Hyprland-icons-themes-4.0_1

# Install epdfview
xbps-install -y --repository=Build/ epdfview-0.1.8_12

# Install usbimager
xbps-install -y --repository=Build/ usbimager-1.0.10_1 

# Install pcompress
xbps-install -y --repository=Build/ pcompress-1.5_1

# Install hardinfo2
xbps-install -y --repository=Build/ hardinfo2-2.2.0_1

# Install Yradio-Hypr
xbps-install -y --repository=Build/ Yradio-Hypr-1.8_1

# Set execution permissions recursivly for binaries and scripts
chmod +x -R /usr/local/bin

# Clean Up
rm -r /root/Build
rm /var/cache/xbps/*

# firewall Gufw
echo gufw \
| xargs -n1 xbps-install -y
ln -s /etc/sv/ufw /etc/runit/runsvdir/default/ufw
#sed -i '/geany/abind = $mainMod, N, exec, sudo env WAYLAND_DISPLAY="$XDG_RUNTIME_DIR\/$WAYLAND_DISPLAY" XDG_RUNTIME_DIR=\/user\/run\/0 dbus-run-session -- gufw-pkexec' /home/spot/.config/hypr/configs/keybinds.conf

rm /var/cache/xbps/*

# enable some key services to start at boot
ln -s /etc/sv/dbus /var/service
ln -s /etc/sv/seatd /var/service
ln -s /etc/sv/bluetoothd /var/service
ln -s /etc/sv/polkitd /var/service
ln -s /etc/sv/polkitd /etc/runit/runsvdir/default/polkitd
ln -s /etc/sv/dbus /etc/runit/runsvdir/default/dbus
ln -s /etc/sv/NetworkManager /etc/runit/runsvdir/default/NetworkManager
ln -s /etc/sv/ntpd /etc/runit/runsvdir/default/ntpd  # /etc/sv/nptd is symlink to chronyd
ln -s /etc/sv/seatd /etc/runit/runsvdir/default/seatd

# set up passwd system
pwconv
grpconv
printf "root\nroot\n" | passwd >/dev/null 2>&1 # Quietly set default root passwd to "root"
# set root to use /bin/bash
usermod --shell /bin/bash root

# Give login user spot no-password admin polkit access rights
mkdir -p /etc/polkit-1/rules/
cat <<'49POLKIT' > /etc/polkit-1/rules/49-nopasswd-wheel.rules
polkit.addRule(function(action, subject) {
    if (subject.user == "spot")
    {
        return polkit.Result.YES;
    }
});
49POLKIT

# Set locale to en_US.UTF-8 
sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/default/libc-locales
sed -i 's/#C.UTF-8 UTF-8/C.UTF-8 UTF-8/' /etc/default/libc-locales
echo "LANG=en_US.UTF-8" >> /etc/environment
xbps-reconfigure -f glibc-locales

# Configure autologin
#
cp -R /etc/sv/agetty-tty1 /etc/sv/agetty-autologin-tty1
# In following change 'spot' for 'root' if you want autologin as root
sed -i 's/GETTY_ARGS.*/GETTY_ARGS="--autologin spot --noclear"/' /etc/sv/agetty-autologin-tty1/conf
#
# Use agetty-autologin-tty1 instead of agetty-tty1 
rm -f /etc/runit/runsvdir/default/agetty-tty1
ln -s /etc/sv/agetty-autologin-tty1 /etc/runit/runsvdir/default/agetty-autologin-tty1
touch /etc/sv/agetty-tty1/down
#
# Remove this section if not wanting boot straight into wayland sway
cat <<'AUTOLOGIN' > /etc/profile.d/autologin.sh
# autologin on tty1
if [ -z "${WAYLAND_DISPLAY}" ] && [ "${XDG_VTNR}" -eq 1 ]; then
  dbus-run-session -- start-hyprland   # use 'exec ...' here if you don't want back to tty1 on exit Hyprland-start-hyprland
fi
AUTOLOGIN

# gks macro allows root to run gui apps when login as regular user (e.g. spot) desktop
cat <<'GKS' >> ~/.bashrc
# To run app as root user from regular user desktop use command: gks <waylandapp>
gks () { xhost +si:localuser:root; sudo -H "$@"; xhost -si:localuser:root; }
GKS

# Some default configs for root 
#
# Default ~/ directories
mkdir -p ~/.config/hypr
mkdir -p ~/Desktop ~/Documents ~/Downloads ~/Music ~/Pictures ~/Public ~/Templates ~/Videos
mkdir -p ~/my-applications ~/Startup

# Some default configs for /home/spot 
#
# Default /home/spot directories
mkdir -p /home/spot/.config/hypr
mkdir -p /home/spot/Desktop /home/spot/Documents /home/spot/Downloads /home/spot/Music /home/spot/Pictures /home/spot/Public /home/spot/Templates /home/spot/Videos
mkdir -p /home/spot/my-applications /home/spot/Startup /home/spot/Pictures/Screenshots

# Set your timezone. Example:
current_timezone="Etc/UTC"
ln -sf /usr/share/zoneinfo/${current_timezone} /etc/localtime
#
# Some extra sway (global) configs
mkdir -p /etc/sway/config.d
cat <<'SWAYEXTRACONF' > /etc/sway/config.d/100-wiak_global
# Can put global sway config entries in here
# bind = $mainMod SHIFT,F, exec, 'sudo env WAYLAND_DISPLAY="$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY"  XDG_RUNTIME_DIR=/user/run/0 dbus-run-session -- pcmanfm'
# bind = $mainMod SHIFT,G, exec, 'sudo env WAYLAND_DISPLAY="$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY"  XDG_RUNTIME_DIR=/user/run/0 dbus-run-session -- geany'
# bind = $mainMod SHIFT,T, exec, 'sudo env WAYLAND_DISPLAY="$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY"  XDG_RUNTIME_DIR=/user/run/0 dbus-run-session -- sakura'
# bind = $mainMod CTRL,G, exec, 'sudo env WAYLAND_DISPLAY="$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY"  XDG_RUNTIME_DIR=/user/run/0 dbus-run-session -- gparted'
# bind = $mainMod, N, exec, 'sudo env WAYLAND_DISPLAY="$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" XDG_RUNTIME_DIR=/user/run/0 dbus-run-session -- gufw-pkexec' 
SWAYEXTRACONF

# Configure system for multi-users
#
cp -af /root/. /etc/skel
mkdir -p /etc/skel/.config /etc/skel/.cache /etc/skel/.local/share
#
# Create user spot and put in wheel group (and more) and give wheel group nopasswd sudo rights
echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (VISUAL="tee -a" visudo) # wheel group added to sudo no password required
useradd -m -G audio,video,wheel,storage -s /bin/bash spot
printf "spot\nspot" | passwd spot >/dev/null 2>&1 # Quietly set default spot passwd to "spot"

# Set permissions
# chmod 700 /run/user/$(id -u) 
chown -R spot:spot /home/spot
usermod -a -G audio spot
usermod -a -G video spot
usermod -a -G _seatd spot

#-----------------------------------------------------------------------
echo "desktop build process finished"

